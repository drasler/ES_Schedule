<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ActualTimeCalc æ’ç¨‹ç§»æ¤è¦åŠƒæ›¸</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 3rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 3px solid var(--primary);
        }

        header h1 {
            font-size: 2.2rem;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .meta-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--gray-50);
            border-radius: 12px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .meta-item .label {
            font-weight: 600;
            color: var(--gray-700);
        }

        .meta-item .value {
            color: var(--primary);
        }

        section {
            margin-bottom: 2.5rem;
        }

        section h2 {
            font-size: 1.5rem;
            color: var(--gray-800);
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 4px solid var(--primary);
        }

        section h3 {
            font-size: 1.2rem;
            color: var(--gray-700);
            margin: 1.5rem 0 1rem;
        }

        .card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
        }

        code {
            background: var(--gray-100);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            color: var(--primary-dark);
        }

        pre {
            background: var(--gray-900);
            color: #e5e7eb;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        .mermaid {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .file-tree {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1.5rem;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
        }

        .file-tree .folder {
            color: var(--primary);
            font-weight: 600;
        }

        .file-tree .new {
            color: var(--success);
        }

        footer {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-600);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š ActualTimeCalc æ’ç¨‹ç§»æ¤è¦åŠƒæ›¸</h1>
            <p style="color: #4b5563;">å·¥æ™‚è¨ˆç®—æ’ç¨‹ä»»å‹™ - å¾ ACTUAL_TIME_Calc_EE ç§»æ¤è‡³ ES_Schedule</p>
        </header>

        <div class="meta-info">
            <div class="meta-item">
                <span class="label">ğŸ“… è¦åŠƒæ—¥æœŸ:</span>
                <span class="value">2026-01-15</span>
            </div>
            <div class="meta-item">
                <span class="label">ğŸ“¦ ä¾†æºå°ˆæ¡ˆ:</span>
                <span class="value">@ACTUAL_TIME_Calc_EE</span>
            </div>
            <div class="meta-item">
                <span class="label">ğŸ¯ ç›®æ¨™å°ˆæ¡ˆ:</span>
                <span class="value">ES_Schedule</span>
            </div>
            <div class="meta-item">
                <span class="label">ğŸ“Š ç‹€æ…‹:</span>
                <span class="value">å¾…å¯©æ ¸</span>
            </div>
        </div>

        <!-- åŸå§‹å°ˆæ¡ˆåˆ†æ -->
        <section>
            <h2>ğŸ” åŸå§‹å°ˆæ¡ˆåˆ†æ</h2>

            <div class="card">
                <h3>å°ˆæ¡ˆåŠŸèƒ½æè¿°</h3>
                <p><strong>ACTUAL_TIME_Calc_EE</strong> æ˜¯ä¸€å€‹å·¥æ™‚è¨ˆç®—æ’ç¨‹ç¨‹å¼ï¼Œä¸»è¦åŠŸèƒ½ç‚ºï¼š</p>
                <ol>
                    <li>å¾ <strong>MSSQL (AMES_DB)</strong> è®€å–å·¥æ™‚è³‡æ–™ (<code>JH_WO_TIMESHEET</code>)</li>
                    <li>è¨ˆç®—å„è£½ç¨‹çš„å¯¦éš›å·¥æ™‚èˆ‡å®Œæˆæ•¸é‡</li>
                    <li>å°‡è¨ˆç®—çµæœå¯«å…¥ <strong>Oracle (JHDB)</strong> çš„ <code>ACTUAL_TIME</code> å’Œ
                        <code>ACTUAL_TIME_DETAIL</code></li>
                    <li>ç”¢ç”Ÿ SAP ä¸Šå‚³ç”¨çš„ TXT æª”æ¡ˆ</li>
                </ol>
            </div>

            <div class="card">
                <h3>åŸå§‹å°ˆæ¡ˆçµæ§‹</h3>
                <table>
                    <thead>
                        <tr>
                            <th>æª”æ¡ˆ</th>
                            <th>èªªæ˜</th>
                            <th>è¡Œæ•¸</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>Program.cs</code></td>
                            <td>ä¸»ç¨‹å¼é‚è¼¯</td>
                            <td>633</td>
                        </tr>
                        <tr>
                            <td><code>SqlHelper.cs</code></td>
                            <td>MSSQL é€£ç·šå·¥å…·é¡</td>
                            <td>228</td>
                        </tr>
                        <tr>
                            <td><code>Models/ActualTime.cs</code></td>
                            <td>å ±å·¥ä¸»è¡¨æ¨¡å‹</td>
                            <td>24</td>
                        </tr>
                        <tr>
                            <td><code>Models/ActualTimeDetail.cs</code></td>
                            <td>å ±å·¥æ˜ç´°æ¨¡å‹</td>
                            <td>31</td>
                        </tr>
                        <tr>
                            <td><code>Models/EVER_SUM_AMESDB.cs</code></td>
                            <td>å·¥æ™‚è³‡æ–™æ¨¡å‹</td>
                            <td>82</td>
                        </tr>
                        <tr>
                            <td><code>Models/*.cs</code></td>
                            <td>å…¶ä»–è¼”åŠ©æ¨¡å‹</td>
                            <td>~50</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h3>è³‡æ–™åº«é€£ç·š</h3>
                <table>
                    <thead>
                        <tr>
                            <th>é€£ç·šåç¨±</th>
                            <th>è³‡æ–™åº«é¡å‹</th>
                            <th>ç”¨é€”</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>JHDB</code></td>
                            <td>Oracle</td>
                            <td>ç›®æ¨™è³‡æ–™åº« (å¯«å…¥ ACTUAL_TIME)</td>
                        </tr>
                        <tr>
                            <td><code>EVERSUN_AMESDB</code></td>
                            <td>MSSQL</td>
                            <td>ä¾†æºè³‡æ–™åº« (è®€å– JH_WO_TIMESHEET)</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- è³‡æ–™æµç¨‹åœ– -->
        <section>
            <h2>ğŸ“Š è³‡æ–™æµç¨‹åœ–</h2>
            <div class="card">
                <pre class="mermaid">
flowchart LR
    subgraph Source["ä¾†æº MSSQL (AMES_DB)"]
        S1[JH_WO_TIMESHEET]
        S2[JH_STANDARD_WORKTIME]
    end
    
    subgraph Process["ActualTimeCalcJob è™•ç†"]
        P1[Read_Ever_AMES_DB]
        P2[è¨ˆç®—å„è£½ç¨‹å·¥æ™‚]
        P3[UploadTOSap]
    end
    
    subgraph Target["ç›®æ¨™ Oracle (JHDB)"]
        T1[ACTUAL_TIME]
        T2[ACTUAL_TIME_DETAIL]
    end
    
    subgraph Output["è¼¸å‡ºæª”æ¡ˆ"]
        O1[SFIS_WorkTime_*.txt]
    end
    
    S1 --> P1
    S2 --> P1
    P1 --> P2
    P2 --> T1
    P2 --> T2
    P2 --> P3
    P3 --> O1
    
    style S1 fill:#3b82f6,color:#fff
    style T1 fill:#f59e0b,color:#fff
    style O1 fill:#10b981,color:#fff
                </pre>
            </div>
        </section>

        <!-- ç§»æ¤è¦åŠƒ -->
        <section>
            <h2>ğŸ“ ç§»æ¤è¦åŠƒ</h2>

            <div class="alert alert-info">
                <span>ğŸ’¡</span>
                <div>
                    <strong>ç§»æ¤ç­–ç•¥ï¼š</strong>
                    <p>å»ºç«‹æ–°çš„ <code>ActualTimeCalcJob</code> å¯¦ä½œ <code>IScheduleJob</code> ä»‹é¢ï¼Œå°‡åŸå§‹ Program.cs çš„é‚è¼¯åˆ†é›¢è‡³ Service
                        å±¤ï¼Œä¸¦æ•´åˆç¾æœ‰çš„ Logger æ©Ÿåˆ¶ã€‚</p>
                </div>
            </div>

            <h3>æ–°å¢æª”æ¡ˆæ¸…å–®</h3>
            <div class="file-tree">
                <pre>ES_Schedule/
â”œâ”€â”€ <span class="folder">Jobs/</span>
â”‚   â””â”€â”€ <span class="new">[NEW] ActualTimeCalcJob.cs</span>       # æ–°æ’ç¨‹ä»»å‹™å…¥å£
â”‚
â”œâ”€â”€ <span class="folder">Services/</span>
â”‚   â””â”€â”€ <span class="new">[NEW] ActualTimeCalcService.cs</span>  # æ¥­å‹™é‚è¼¯æœå‹™
â”‚
â”œâ”€â”€ <span class="folder">Models/</span>
â”‚   â”œâ”€â”€ <span class="new">[NEW] ActualTime.cs</span>             # å ±å·¥ä¸»è¡¨
â”‚   â”œâ”€â”€ <span class="new">[NEW] ActualTimeDetail.cs</span>       # å ±å·¥æ˜ç´°
â”‚   â””â”€â”€ <span class="new">[NEW] TimesheetRecord.cs</span>        # å·¥æ™‚è¨˜éŒ„ (åŸ EVER_SUM_AMESDB)
â”‚
â”œâ”€â”€ <span class="folder">Helpers/</span>
â”‚   â””â”€â”€ <span class="new">[NEW] MSSqlHelper.cs</span>            # MSSQL é€£ç·šå·¥å…·
â”‚
â”œâ”€â”€ <span class="folder">Repositories/</span>
â”‚   â”œâ”€â”€ <span class="new">[NEW] ActualTimeRepository.cs</span>   # Oracle è³‡æ–™å­˜å–
â”‚   â””â”€â”€ <span class="new">[NEW] TimesheetRepository.cs</span>    # MSSQL è³‡æ–™å­˜å–
â”‚
â”œâ”€â”€ [MODIFY] Services/JobFactory.cs      # è¨»å†Šæ–°ä»»å‹™
â”œâ”€â”€ [MODIFY] App.config                  # æ–°å¢é€£ç·šå­—ä¸²
â””â”€â”€ [MODIFY] ES_Schedule.csproj          # æ–°å¢æª”æ¡ˆåƒè€ƒ</pre>
            </div>
        </section>

        <!-- App.config æ›´æ–° -->
        <section>
            <h2>âš™ï¸ é…ç½®æ›´æ–°</h2>

            <div class="card">
                <h3>App.config æ–°å¢é …ç›®</h3>
                <pre><code>&lt;connectionStrings&gt;
  &lt;!-- æ—¢æœ‰ --&gt;
  &lt;add name="SourceDatabase" ... /&gt;
  &lt;add name="DestinationDatabase" ... /&gt;
  
  &lt;!-- æ–°å¢ ActualTimeCalc ç”¨ --&gt;
  &lt;add name="JHDB" connectionString="..." providerName="Oracle.ManagedDataAccess.Client" /&gt;
  &lt;add name="EVERSUN_AMESDB" connectionString="..." providerName="System.Data.SqlClient" /&gt;
&lt;/connectionStrings&gt;

&lt;appSettings&gt;
  &lt;!-- æ—¢æœ‰ --&gt;
  &lt;add key="LogPath" value="Logs" /&gt;
  &lt;add key="BatchSize" value="1000" /&gt;
  
  &lt;!-- æ–°å¢ ActualTimeCalc ç”¨ --&gt;
  &lt;add key="ActualTime_Schema_JHDB" value="JHAMES" /&gt;
  &lt;add key="ActualTime_Schema_JHDB_SYS" value="JHSYS" /&gt;
  &lt;add key="ActualTime_CalcDate" value="" /&gt;
  &lt;add key="ActualTime_TxtOutputPath" value="Output" /&gt;
&lt;/appSettings&gt;</code></pre>
            </div>
        </section>

        <!-- JobFactory è¨»å†Š -->
        <section>
            <h2>ğŸ”Œ JobFactory è¨»å†Š</h2>

            <div class="card">
                <pre><code>private static readonly Dictionary&lt;string, Func&lt;IScheduleJob&gt;&gt; _jobs 
    = new Dictionary&lt;string, Func&lt;IScheduleJob&gt;&gt;(StringComparer.OrdinalIgnoreCase)
{
    { "RepairRecordsTransfer", () =&gt; new RepairRecordsTransferJob() },
    { "ActualTimeCalc", () =&gt; new ActualTimeCalcJob() },  // æ–°å¢
};</code></pre>
            </div>

            <div class="alert alert-success">
                <span>âœ…</span>
                <div>
                    <strong>Windows å·¥ä½œæ’ç¨‹å™¨è¨­å®šï¼š</strong>
                    <p>å¼•æ•¸æ¬„ä½å¡«å…¥ <code>ActualTimeCalc</code> å³å¯åŸ·è¡Œå·¥æ™‚è¨ˆç®—ä»»å‹™</p>
                </div>
            </div>
        </section>

        <!-- é‡è¦ä¿®æ”¹ -->
        <section>
            <h2>âš ï¸ é‡é»é‡æ§‹é …ç›®</h2>

            <div class="alert alert-warning">
                <span>âš ï¸</span>
                <div>
                    <strong>Console.WriteLine ç§»é™¤ï¼š</strong>
                    <p>åŸå§‹å°ˆæ¡ˆå¤§é‡ä½¿ç”¨ <code>Console.WriteLine</code> å’Œè‡ªè¨‚ <code>Log()</code> æ–¹æ³•ï¼Œéœ€å…¨éƒ¨æ”¹ç‚º
                        <code>Logger.Instance.Info/Error</code>ã€‚</p>
                </div>
            </div>

            <div class="card">
                <h3>éœ€ç§»é™¤/æ›¿æ›çš„ç¨‹å¼ç¢¼</h3>
                <table>
                    <thead>
                        <tr>
                            <th>åŸå§‹ç¨‹å¼ç¢¼</th>
                            <th>æ›¿æ›ç‚º</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>Console.WriteLine(Logstr)</code></td>
                            <td><code>Logger.Instance.Info(Logstr)</code></td>
                        </tr>
                        <tr>
                            <td><code>File.AppendAllText(_LogFile, ...)</code></td>
                            <td>ç§»é™¤ (å·²ç”± Logger è™•ç†)</td>
                        </tr>
                        <tr>
                            <td><code>Environment.Exit(0)</code></td>
                            <td><code>return 0</code> (é…åˆ Exit Code æ©Ÿåˆ¶)</td>
                        </tr>
                        <tr>
                            <td><code>throw ex</code></td>
                            <td><code>Logger.Instance.Exception(ex); return 3</code></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- é©—è­‰è¨ˆç•« -->
        <section>
            <h2>âœ… é©—è­‰è¨ˆç•«</h2>

            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>æ¸¬è©¦é …ç›®</th>
                            <th>å¼•æ•¸</th>
                            <th>é æœŸçµæœ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ç·¨è­¯å°ˆæ¡ˆ</td>
                            <td>-</td>
                            <td>0 éŒ¯èª¤</td>
                        </tr>
                        <tr>
                            <td>åŸ·è¡Œ ActualTimeCalc</td>
                            <td><code>ActualTimeCalc</code></td>
                            <td>Exit Code 0</td>
                        </tr>
                        <tr>
                            <td>æª¢æŸ¥ Log æª”æ¡ˆ</td>
                            <td>-</td>
                            <td>åŒ…å«å·¥æ™‚è¨ˆç®—è¨˜éŒ„</td>
                        </tr>
                        <tr>
                            <td>æª¢æŸ¥ TXT è¼¸å‡º</td>
                            <td>-</td>
                            <td>SFIS_WorkTime_*.txt ç”¢ç”Ÿ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- NuGet å¥—ä»¶ -->
        <section>
            <h2>ğŸ“¦ NuGet å¥—ä»¶éœ€æ±‚</h2>

            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>å¥—ä»¶åç¨±</th>
                            <th>ç‰ˆæœ¬</th>
                            <th>ç”¨é€”</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Dapper</td>
                            <td>2.1.x</td>
                            <td>è¼•é‡ ORM</td>
                        </tr>
                        <tr>
                            <td>Oracle.ManagedDataAccess</td>
                            <td>21.x</td>
                            <td>Oracle é€£ç·š</td>
                        </tr>
                        <tr>
                            <td>System.Data.SqlClient</td>
                            <td>4.x</td>
                            <td>MSSQL é€£ç·š</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <footer>
            <p>ğŸ“„ ActualTimeCalc Migration Plan v1 | 2026-01-15</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>

</html>